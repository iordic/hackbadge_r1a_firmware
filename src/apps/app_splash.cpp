#include <Arduino.h>
#include <U8g2lib.h>
#include <L33T_Animation.h>

#include "app.h"
#include "display.h"

#define phantom_animation_width 30
#define phantom_animation_height 50
const int sizeBytes = 200;
const int frames = 4;
// width, height, frame_delay (ms), xInc, yInc, xStart, xEnd, yStart, yEnd, nFrames
L33T_Animation PHANTOM(30, 50, 250, 0, 0, 0, 0, 10, 10, frames);
static unsigned char phantom_animation_bits[frames][sizeBytes] = {
   // frame 1
   0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0e, 0x00, 0x00, 0x07, 0x0e, 0x00,
   0x00, 0x9f, 0x1f, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0xff, 0x3f, 0x00,
   0x80, 0xfd, 0x3f, 0x00, 0x80, 0x99, 0x3f, 0x00, 0xc0, 0x9d, 0x7f, 0x00,
   0xc0, 0xf7, 0x7f, 0x00, 0xc0, 0xf7, 0x7f, 0x00, 0xc0, 0xf7, 0xff, 0x00,
   0xc0, 0xff, 0xff, 0x00, 0x80, 0xff, 0xff, 0x01, 0x80, 0xff, 0xff, 0x01,
   0xc8, 0xff, 0xff, 0x01, 0xff, 0xff, 0xff, 0x01, 0xfe, 0xff, 0xff, 0x03,
   0x60, 0xff, 0xfd, 0x03, 0xe0, 0xff, 0xff, 0x03, 0xe0, 0xff, 0xff, 0x07,
   0xe0, 0xff, 0xff, 0x07, 0xc0, 0xff, 0xff, 0x07, 0xc0, 0xff, 0xff, 0x0f,
   0x80, 0xff, 0xff, 0x1f, 0x00, 0xff, 0xff, 0x0f, 0x00, 0xbc, 0xff, 0x1f,
   0x00, 0x78, 0xff, 0x1f, 0x00, 0xf0, 0xff, 0x1f, 0x00, 0xf0, 0xff, 0x0f,
   0x00, 0xf0, 0xff, 0x07, 0x00, 0xf8, 0xff, 0x03, 0x00, 0xf8, 0xff, 0x01,
   0x00, 0xf8, 0xff, 0x00, 0x00, 0xfc, 0xff, 0x00, 0x00, 0xfc, 0xff, 0x00,
   0x00, 0xf8, 0xff, 0x00, 0x00, 0xf8, 0xff, 0x00, 0x00, 0xf0, 0xff, 0x01,
   0x00, 0xe0, 0xff, 0x01, 0x00, 0x80, 0xff, 0x01, 0x00, 0x00, 0xfe, 0x01,
   0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0x01, 0x00, 0x00, 0xfc, 0x03,
   0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xe0, 0x0d,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   // frame 2
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
   0x00, 0x02, 0x0e, 0x00, 0x00, 0x07, 0x0e, 0x00, 0x00, 0x9f, 0x0f, 0x00,
   0x00, 0xfe, 0x1f, 0x00, 0x00, 0xff, 0x3f, 0x00, 0x80, 0xfd, 0x3f, 0x00,
   0x80, 0x99, 0x3f, 0x00, 0xc0, 0x9d, 0x7f, 0x00, 0x80, 0xf7, 0x7f, 0x00,
   0xc0, 0xf7, 0x7f, 0x00, 0xc0, 0xf7, 0xff, 0x00, 0xc0, 0xff, 0xff, 0x00,
   0x80, 0xff, 0xff, 0x01, 0x80, 0xff, 0xff, 0x01, 0xc8, 0xff, 0xff, 0x01,
   0xff, 0xee, 0xf7, 0x03, 0xfe, 0xde, 0xfb, 0x03, 0xe0, 0xff, 0xfd, 0x03,
   0xe0, 0xfe, 0xff, 0x03, 0xe0, 0xff, 0xff, 0x07, 0xe0, 0xff, 0xff, 0x07,
   0xc0, 0xff, 0xff, 0x07, 0xc0, 0xff, 0xff, 0x0f, 0x80, 0xff, 0xff, 0x0f,
   0x00, 0xff, 0xff, 0x1f, 0x00, 0xbc, 0xff, 0x1f, 0x00, 0x70, 0xff, 0x1f,
   0x00, 0xe0, 0xff, 0x1f, 0x00, 0xc0, 0xff, 0x1f, 0x00, 0xc0, 0xff, 0x0f,
   0x00, 0xc0, 0xff, 0x0f, 0x00, 0xe0, 0xff, 0x0f, 0x00, 0xe0, 0xff, 0x07,
   0x00, 0xe0, 0xff, 0x03, 0x00, 0xf0, 0xff, 0x03, 0x00, 0xf0, 0xff, 0x03,
   0x00, 0xe0, 0xff, 0x01, 0x00, 0xe0, 0xff, 0x01, 0x00, 0xc0, 0xff, 0x01,
   0x00, 0x80, 0xff, 0x01, 0x00, 0x00, 0xfe, 0x01, 0x00, 0x00, 0xf8, 0x03,
   0x00, 0x00, 0xf8, 0x03, 0x00, 0x00, 0xf8, 0x03, 0x00, 0x00, 0xf0, 0x0f,
   0x00, 0x00, 0xc0, 0x0f, 0x00, 0x00, 0x00, 0x08,
   // frame 3 
   0x00, 0x00, 0x04, 0x00, 0x00, 0x06, 0x0e, 0x00, 0x00, 0x0e, 0x0e, 0x00,
   0x00, 0xde, 0x1f, 0x00, 0x00, 0xff, 0x3f, 0x00, 0x00, 0xff, 0x3f, 0x00,
   0x80, 0xbd, 0x3f, 0x00, 0x80, 0xb9, 0x7f, 0x00, 0xc0, 0xb9, 0x7f, 0x00,
   0x40, 0xf7, 0x7f, 0x00, 0xc0, 0xf7, 0xff, 0x00, 0x80, 0xf7, 0xff, 0x00,
   0x00, 0x7f, 0xff, 0x01, 0x80, 0xff, 0xff, 0x01, 0x80, 0xff, 0xff, 0x01,
   0xdc, 0xff, 0xff, 0x03, 0xff, 0xfd, 0xff, 0x03, 0x7f, 0xff, 0xff, 0x03,
   0xe0, 0xfe, 0xfc, 0x03, 0xe0, 0xff, 0xff, 0x03, 0xc0, 0xff, 0xff, 0x07,
   0xe0, 0xff, 0xff, 0x0f, 0xc0, 0xdf, 0xff, 0x0f, 0xc0, 0xff, 0xff, 0x1f,
   0x80, 0xff, 0xff, 0x1f, 0x00, 0xff, 0xff, 0x1f, 0x00, 0xfc, 0xff, 0x1f,
   0x00, 0x78, 0xff, 0x3f, 0x00, 0xf0, 0xff, 0x1f, 0x00, 0xf0, 0xff, 0x3f,
   0x00, 0xf0, 0xff, 0x3f, 0x00, 0xf0, 0xff, 0x3f, 0x00, 0xe0, 0xff, 0x3f,
   0x00, 0x80, 0xff, 0x3f, 0x00, 0x00, 0xff, 0x3f, 0x00, 0x00, 0xfe, 0x1f,
   0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0xff, 0x0f, 0x00, 0x00, 0xff, 0x0f,
   0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0xff, 0x03, 0x00, 0x00, 0xfe, 0x01,
   0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0x01,
   0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xf8, 0x1f, 0x00, 0x00, 0xf0, 0x0f,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
   // frame 4
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x03, 0x0e, 0x00, 0x00, 0x07, 0x0e, 0x00, 0x00, 0xdf, 0x1f, 0x00,
   0x00, 0xff, 0x1f, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0xdd, 0x3f, 0x00,
   0x80, 0x99, 0x3f, 0x00, 0xc0, 0x9d, 0x3f, 0x00, 0x00, 0xf7, 0x7f, 0x00,
   0xc0, 0xf7, 0x7f, 0x00, 0xc0, 0xf7, 0xff, 0x00, 0xc0, 0xff, 0xfd, 0x00,
   0x80, 0xff, 0xff, 0x01, 0x80, 0xff, 0xff, 0x01, 0x90, 0xff, 0xff, 0x01,
   0xff, 0xff, 0xff, 0x03, 0xff, 0x9e, 0xff, 0x01, 0xf0, 0xfe, 0xfd, 0x03,
   0xe0, 0xff, 0xff, 0x03, 0xe0, 0xff, 0xff, 0x07, 0xe0, 0xef, 0xff, 0x07,
   0xc0, 0xff, 0xff, 0x0f, 0xc0, 0xff, 0xff, 0x0f, 0x80, 0xff, 0xff, 0x0f,
   0x00, 0xdf, 0xff, 0x1f, 0x00, 0xbc, 0xff, 0x1f, 0x00, 0x78, 0xff, 0x1f,
   0x00, 0xe0, 0xff, 0x1f, 0x00, 0xc0, 0xff, 0x0f, 0x00, 0x80, 0xff, 0x07,
   0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x0f,
   0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x1f, 0x00, 0x00, 0xfc, 0x0f,
   0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xfc, 0x07, 0x00, 0x00, 0xf8, 0x07,
   0x00, 0x00, 0xfc, 0x03, 0x00, 0x00, 0xfc, 0x01, 0x00, 0x00, 0xfc, 0x00,
   0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0xfe, 0x19, 0x00, 0x00, 0xfc, 0x0f,
   0x00, 0x00, 0xfc, 0x0f, 0x00, 0x00, 0xf0, 0x03
};

void splash_onStart() {}

void splash_onStop() {}

void splash_onEvent(int evt) {
    switch (evt) {
    case BTN_LEFT:
        Serial.println("Pressed lefT!");
        break;
    case BTN_UP:
        break;
    case BTN_RIGHT:
        break;
    case BTN_DOWN:
        break;
    case BTN_OK:
        Serial.println("ok!");
        break;
    case BTN_BACK:
        Serial.println("Back!");
        break;
    default:
        break;
    }
}

void splash_onDraw(U8G2 *u8g2) {
    u8g2->clearBuffer();
    u8g2->drawFrame(38, 16, 88, 32);
    u8g2->setFont(u8g2_font_5x8_mf);
    u8g2->drawStr(44, 18, "badge:-$ whoami");
    u8g2->setFont(u8g2_font_littlemissloudonbold_tr);
    u8g2->drawStr(42, 30, "@iordic");
    u8g2->setFont(u8g2_font_6x10_mf);
    u8g2->drawUTF8(40, 42, "Jordi CastellÃ³");

    PHANTOM.chkAnimation(true);
    u8g2->drawXBM(PHANTOM.getXpos(), PHANTOM.getYpos(), PHANTOM.getWidth(), PHANTOM.getHeight(), phantom_animation_bits[PHANTOM.getCurrentFrame()]); 
    if (PHANTOM.toReset())
        PHANTOM.resetAni();
    u8g2->sendBuffer();
}

App app_splash = {
  .name = "Splash",
  .onStart = splash_onStart,
  .onEvent = splash_onEvent,
  .onDraw = splash_onDraw,
  .onStop = splash_onStop
};
